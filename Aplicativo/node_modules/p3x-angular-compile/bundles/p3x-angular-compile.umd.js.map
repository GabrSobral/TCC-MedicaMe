{"version":3,"file":"p3x-angular-compile.umd.js","sources":["../../../projects/angular-compile/src/lib/angular-compile.component.ts","../../../projects/angular-compile/src/lib/angular-compile.module.ts","../../../projects/angular-compile/src/public-api.ts","../../../projects/angular-compile/src/p3x-angular-compile.ts"],"sourcesContent":["import {\n    Compiler,\n    Component,\n    Injectable,\n    Input,\n    ModuleWithProviders,\n    NgModule,\n    NgModuleFactory,\n    OnChanges,\n    SimpleChanges,\n    Type,\n} from '@angular/core';\n\nimport {CommonModule} from '@angular/common';\n//import { BrowserModule } from '@angular/platform-browser';\n//let SingletonDefaultModule: NgModule;\n//import cloneDeep from 'lodash/cloneDeep';\n\n//import { CorifeusMaterialModule } from 'corifeus-web-material';\n\nfunction reverse(str: string) {\n    return str.split('').reverse().join('')\n}\n\nfunction random() {\n    return (Math.floor(Math.random() * (99999999999999999 - 10000000000000000)) + 10000000000000000).toString(16)\n}\n\nlet currentIdTime: number;\nlet currentId = 0;\n\nfunction nextId(): string {\n\n    const now = Date.now();\n    if (currentIdTime !== now) {\n        currentId = 0;\n        currentIdTime = now\n    }\n    const comingId = ++currentId;\n    const randomHex = reverse(random()).padStart(15, '0');\n    const timeHex = reverse(currentIdTime.toString(16).padStart(12, '0'))\n    const comingIdHex = reverse(comingId.toString(16).padStart(3, '0'))\n    const newId: string = `p3x-angular-compile-${timeHex}${comingIdHex}${randomHex}`;\n    //console.log(newId)\n    return newId\n}\n\n\n//const cache : any = {};\n\n@Component({\n    selector: '[p3x-compile]',\n    template: `\n        <ng-container *ngIf=\"renderComponent\">\n            <ng-container *ngComponentOutlet=\"dynamicComponent; ngModuleFactory: dynamicModule;\"></ng-container>\n        </ng-container>\n    `\n})\n@Injectable()\nexport class CompileAttribute implements OnChanges {\n//export class CompileAttribute implements OnChanges ,OnInit {\n\n    @Input('p3x-compile')\n    html: string;\n\n    @Input('p3x-compile-ctx')\n    context: any;\n\n    @Input('p3x-compile-error-handler')\n    errorHandler: Function = undefined;\n\n    dynamicComponent: any;\n    dynamicModule: NgModuleFactory<any> | any;\n\n    @Input('p3x-compile-module')\n    module: NgModule;\n\n    @Input('p3x-compile-imports')\n    imports: Array<Type<any> | ModuleWithProviders<any> | any[]>;\n\n    constructor(\n        //  private container: ViewContainerRef,\n        // private service: CompileService\n        private compiler: Compiler,\n        // @Inject('config') private config:CompileServiceConfig\n    ) {\n    }\n\n    /*\n    // not requires, since ngOnChanges does it first time change\n    ngOnInit() {\n        //console.log('ng init')\n       // this.update();\n    }\n     */\n\n    get renderComponent() {\n        return typeof this.html === 'string' && this.html.trim() !== ''\n    }\n\n    ngOnChanges(changes: SimpleChanges) {\n        //console.log('ng one changes')\n        this.update();\n    }\n\n\n    update() {\n        try {\n            if (this.html === undefined || this.html === null || this.html.trim() === '') {\n                //            this.container.clear();\n                this.dynamicComponent = undefined;\n                this.dynamicModule = undefined;\n                return;\n            }\n\n            /*\n\n            // looks like Angular already is caching\n\n            //console.log('html', this.html)\n            const cacheKey = this.html;\n            //console.log(Object.keys(cache).indexOf(cacheKey), cache)\n            if (cache.hasOwnProperty(cacheKey)) {\n                const currentCache = cache[cacheKey];\n                this.dynamicComponent = currentCache.dynamicComponent\n                this.dynamicModule = currentCache.dynamicModule\n                return ;\n            }\n            */\n            this.dynamicComponent = this.createNewComponent(this.html, this.context);\n            this.dynamicModule = this.compiler.compileModuleSync(this.createComponentModule(this.dynamicComponent));\n\n            /*\n            cache[cacheKey] = {\n                dynamicComponent: this.dynamicComponent,\n                dynamicModule: this.dynamicModule,\n            };\n            */\n        } catch (e) {\n            if (this.errorHandler === undefined) {\n                throw e;\n            } else {\n                this.errorHandler(e);\n            }\n        }\n        /*\n        // now we use it with ngComponentOutlet, since about angular 5\n        await this.service.compile({\n            template: this.html,\n            container: this.container,\n            context: this.context,\n            imports: this.imports,\n            module: this.module\n        })\n        */\n    }\n\n    private createComponentModule(componentType: any) {\n        let module: NgModule = {};\n\n        if (this.module !== undefined) {\n            module = Object.assign({}, this.module);\n        }\n        /*\n        else if (SingletonDefaultModule !== undefined && SingletonDefaultModule !== null) {\n            module = cloneDeep(SingletonDefaultModule);\n        }\n        */\n        module.imports = module.imports || [];\n        module.imports.push(CommonModule);\n        if (this.imports !== undefined) {\n            module.imports = module.imports.concat(this.imports)\n        }\n        if (module.declarations === undefined) {\n            module.declarations = [\n                componentType\n            ];\n        } else {\n            module.declarations.push(componentType);\n        }\n        module.entryComponents = [\n            componentType\n        ];\n\n        @NgModule(module)\n        class RuntimeComponentModule {\n        }\n\n        return RuntimeComponentModule;\n    }\n\n\n    private createNewComponent(html: string, context: any) {\n\n        const selector: string = nextId()\n\n        @Component({\n            selector: selector,\n            template: html\n        })\n        class DynamicComponent {\n            context: any = context;\n        }\n\n        return DynamicComponent;\n    }\n}\n","import {\n    NgModule,\n    //ModuleWithProviders,\n} from '@angular/core';\nimport {CompileAttribute} from \"./angular-compile.component\";\nimport {CommonModule} from '@angular/common';\n\n@NgModule({\n  declarations: [\n      CompileAttribute\n  ],\n  imports: [\n      CommonModule\n  ],\n  exports: [\n      CompileAttribute\n  ]\n})\nexport class CompileModule { }\n","/*\n * Public API Surface of angular-compile\n */\n\nexport * from './lib/angular-compile.module';\nexport * from './lib/angular-compile.component';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":["CommonModule","NgModule","Component","Injectable","Compiler","Input"],"mappings":"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"}