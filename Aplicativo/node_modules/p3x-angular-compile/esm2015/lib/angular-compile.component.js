import { Compiler, Component, Injectable, Input, NgModule, } from '@angular/core';
import { CommonModule } from '@angular/common';
//import { BrowserModule } from '@angular/platform-browser';
//let SingletonDefaultModule: NgModule;
//import cloneDeep from 'lodash/cloneDeep';
//import { CorifeusMaterialModule } from 'corifeus-web-material';
function reverse(str) {
    return str.split('').reverse().join('');
}
function random() {
    return (Math.floor(Math.random() * (99999999999999999 - 10000000000000000)) + 10000000000000000).toString(16);
}
let currentIdTime;
let currentId = 0;
function nextId() {
    const now = Date.now();
    if (currentIdTime !== now) {
        currentId = 0;
        currentIdTime = now;
    }
    const comingId = ++currentId;
    const randomHex = reverse(random()).padStart(15, '0');
    const timeHex = reverse(currentIdTime.toString(16).padStart(12, '0'));
    const comingIdHex = reverse(comingId.toString(16).padStart(3, '0'));
    const newId = `p3x-angular-compile-${timeHex}${comingIdHex}${randomHex}`;
    //console.log(newId)
    return newId;
}
//const cache : any = {};
export class CompileAttribute {
    constructor(
    //  private container: ViewContainerRef,
    // private service: CompileService
    compiler) {
        this.compiler = compiler;
        this.errorHandler = undefined;
    }
    /*
    // not requires, since ngOnChanges does it first time change
    ngOnInit() {
        //console.log('ng init')
       // this.update();
    }
     */
    get renderComponent() {
        return typeof this.html === 'string' && this.html.trim() !== '';
    }
    ngOnChanges(changes) {
        //console.log('ng one changes')
        this.update();
    }
    update() {
        try {
            if (this.html === undefined || this.html === null || this.html.trim() === '') {
                //            this.container.clear();
                this.dynamicComponent = undefined;
                this.dynamicModule = undefined;
                return;
            }
            /*

            // looks like Angular already is caching

            //console.log('html', this.html)
            const cacheKey = this.html;
            //console.log(Object.keys(cache).indexOf(cacheKey), cache)
            if (cache.hasOwnProperty(cacheKey)) {
                const currentCache = cache[cacheKey];
                this.dynamicComponent = currentCache.dynamicComponent
                this.dynamicModule = currentCache.dynamicModule
                return ;
            }
            */
            this.dynamicComponent = this.createNewComponent(this.html, this.context);
            this.dynamicModule = this.compiler.compileModuleSync(this.createComponentModule(this.dynamicComponent));
            /*
            cache[cacheKey] = {
                dynamicComponent: this.dynamicComponent,
                dynamicModule: this.dynamicModule,
            };
            */
        }
        catch (e) {
            if (this.errorHandler === undefined) {
                throw e;
            }
            else {
                this.errorHandler(e);
            }
        }
        /*
        // now we use it with ngComponentOutlet, since about angular 5
        await this.service.compile({
            template: this.html,
            container: this.container,
            context: this.context,
            imports: this.imports,
            module: this.module
        })
        */
    }
    createComponentModule(componentType) {
        let module = {};
        if (this.module !== undefined) {
            module = Object.assign({}, this.module);
        }
        /*
        else if (SingletonDefaultModule !== undefined && SingletonDefaultModule !== null) {
            module = cloneDeep(SingletonDefaultModule);
        }
        */
        module.imports = module.imports || [];
        module.imports.push(CommonModule);
        if (this.imports !== undefined) {
            module.imports = module.imports.concat(this.imports);
        }
        if (module.declarations === undefined) {
            module.declarations = [
                componentType
            ];
        }
        else {
            module.declarations.push(componentType);
        }
        module.entryComponents = [
            componentType
        ];
        class RuntimeComponentModule {
        }
        RuntimeComponentModule.decorators = [
            { type: NgModule, args: [module,] }
        ];
        return RuntimeComponentModule;
    }
    createNewComponent(html, context) {
        const selector = nextId();
        class DynamicComponent {
            constructor() {
                this.context = context;
            }
        }
        DynamicComponent.decorators = [
            { type: Component, args: [{
                        selector: selector,
                        template: html
                    },] }
        ];
        return DynamicComponent;
    }
}
CompileAttribute.decorators = [
    { type: Component, args: [{
                selector: '[p3x-compile]',
                template: `
        <ng-container *ngIf="renderComponent">
            <ng-container *ngComponentOutlet="dynamicComponent; ngModuleFactory: dynamicModule;"></ng-container>
        </ng-container>
    `
            },] },
    { type: Injectable }
];
CompileAttribute.ctorParameters = () => [
    { type: Compiler }
];
CompileAttribute.propDecorators = {
    html: [{ type: Input, args: ['p3x-compile',] }],
    context: [{ type: Input, args: ['p3x-compile-ctx',] }],
    errorHandler: [{ type: Input, args: ['p3x-compile-error-handler',] }],
    module: [{ type: Input, args: ['p3x-compile-module',] }],
    imports: [{ type: Input, args: ['p3x-compile-imports',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1jb21waWxlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItY29tcGlsZS9zcmMvbGliL2FuZ3VsYXItY29tcGlsZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFFBQVEsRUFDUixTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssRUFFTCxRQUFRLEdBS1gsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLDREQUE0RDtBQUM1RCx1Q0FBdUM7QUFDdkMsMkNBQTJDO0FBRTNDLGlFQUFpRTtBQUVqRSxTQUFTLE9BQU8sQ0FBQyxHQUFXO0lBQ3hCLE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7QUFDM0MsQ0FBQztBQUVELFNBQVMsTUFBTTtJQUNYLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDLENBQUMsR0FBRyxpQkFBaUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtBQUNqSCxDQUFDO0FBRUQsSUFBSSxhQUFxQixDQUFDO0FBQzFCLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQztBQUVsQixTQUFTLE1BQU07SUFFWCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDdkIsSUFBSSxhQUFhLEtBQUssR0FBRyxFQUFFO1FBQ3ZCLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDZCxhQUFhLEdBQUcsR0FBRyxDQUFBO0tBQ3RCO0lBQ0QsTUFBTSxRQUFRLEdBQUcsRUFBRSxTQUFTLENBQUM7SUFDN0IsTUFBTSxTQUFTLEdBQUcs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TyxDQUFDLENBQUE7U0FDdkQ7UUFDRCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEtBQUssU0FBUyxFQUFFO1lBQ25DLE1BQU0sQ0FBQyxZQUFZLEdBQUc7Z0JBQ2xCLGFBQWE7YUFDaEIsQ0FBQztTQUNMO2FBQU07WUFDSCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUMzQztRQUNELE1BQU0sQ0FBQyxlQUFlLEdBQUc7WUFDckIsYUFBYTtTQUNoQixDQUFDO1FBRUYsTUFDTSxzQkFBc0I7OztvQkFEM0IsUUFBUSxTQUFDLE1BQU07O1FBSWhCLE9BQU8sc0JBQXNCLENBQUM7SUFDbEMsQ0FBQztJQUdPLGtCQUFrQixDQUFDLElBQVksRUFBRSxPQUFZO1FBRWpELE1BQU0sUUFBUSxHQUFXLE1BQU0sRUFBRSxDQUFBO1FBRWpDLE1BSU0sZ0JBQWdCO1lBSnRCO2dCQUtJLFlBQU8sR0FBUSxPQUFPLENBQUM7WUFDM0IsQ0FBQzs7O29CQU5BLFNBQVMsU0FBQzt3QkFDUCxRQUFRLEVBQUUsUUFBUTt3QkFDbEIsUUFBUSxFQUFFLElBQUk7cUJBQ2pCOztRQUtELE9BQU8sZ0JBQWdCLENBQUM7SUFDNUIsQ0FBQzs7O1lBM0pKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsZUFBZTtnQkFDekIsUUFBUSxFQUFFOzs7O0tBSVQ7YUFDSjtZQUNBLFVBQVU7OztZQXpEUCxRQUFROzs7bUJBNkRQLEtBQUssU0FBQyxhQUFhO3NCQUduQixLQUFLLFNBQUMsaUJBQWlCOzJCQUd2QixLQUFLLFNBQUMsMkJBQTJCO3FCQU1qQyxLQUFLLFNBQUMsb0JBQW9CO3NCQUcxQixLQUFLLFNBQUMscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBDb21waWxlcixcbiAgICBDb21wb25lbnQsXG4gICAgSW5qZWN0YWJsZSxcbiAgICBJbnB1dCxcbiAgICBNb2R1bGVXaXRoUHJvdmlkZXJzLFxuICAgIE5nTW9kdWxlLFxuICAgIE5nTW9kdWxlRmFjdG9yeSxcbiAgICBPbkNoYW5nZXMsXG4gICAgU2ltcGxlQ2hhbmdlcyxcbiAgICBUeXBlLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHtDb21tb25Nb2R1bGV9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG4vL2ltcG9ydCB7IEJyb3dzZXJNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbi8vbGV0IFNpbmdsZXRvbkRlZmF1bHRNb2R1bGU6IE5nTW9kdWxlO1xuLy9pbXBvcnQgY2xvbmVEZWVwIGZyb20gJ2xvZGFzaC9jbG9uZURlZXAnO1xuXG4vL2ltcG9ydCB7IENvcmlmZXVzTWF0ZXJpYWxNb2R1bGUgfSBmcm9tICdjb3JpZmV1cy13ZWItbWF0ZXJpYWwnO1xuXG5mdW5jdGlvbiByZXZlcnNlKHN0cjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHN0ci5zcGxpdCgnJykucmV2ZXJzZSgpLmpvaW4oJycpXG59XG5cbmZ1bmN0aW9uIHJhbmRvbSgpIHtcbiAgICByZXR1cm4gKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqICg5OTk5OTk5OTk5OTk5OTk5OSAtIDEwMDAwMDAwMDAwMDAwMDAwKSkgKyAxMDAwMDAwMDAwMDAwMDAwMCkudG9TdHJpbmcoMTYpXG59XG5cbmxldCBjdXJyZW50SWRUaW1lOiBudW1iZXI7XG5sZXQgY3VycmVudElkID0gMDtcblxuZnVuY3Rpb24gbmV4dElkKCk6IHN0cmluZyB7XG5cbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGlmIChjdXJyZW50SWRUaW1lICE9PSBub3cpIHtcbiAgICAgICAgY3VycmVudElkID0gMDtcbiAgICAgICAgY3VycmVudElkVGltZSA9IG5vd1xuICAgIH1cbiAgICBjb25zdCBjb21pbmdJZCA9ICsrY3VycmVudElkO1xuICAgIGNvbnN0IHJhbmRvbUhleCA9IHJldmVyc2UocmFuZG9tKCkpLnBhZFN0YXJ0KDE1LCAnMCcpO1xuICAgIGNvbnN0IHRpbWVIZXggPSByZXZlcnNlKGN1cnJlbnRJZFRpbWUudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDEyLCAnMCcpKVxuICAgIGNvbnN0IGNvbWluZ0lkSGV4ID0gcmV2ZXJzZShjb21pbmdJZC50b1N0cmluZygxNikucGFkU3RhcnQoMywgJzAnKSlcbiAgICBjb25zdCBuZXdJZDogc3RyaW5nID0gYHAzeC1hbmd1bGFyLWNvbXBpbGUtJHt0aW1lSGV4fSR7Y29taW5nSWRIZXh9JHtyYW5kb21IZXh9YDtcbiAgICAvL2NvbnNvbGUubG9nKG5ld0lkKVxuICAgIHJldHVybiBuZXdJZFxufVxuXG5cbi8vY29uc3QgY2FjaGUgOiBhbnkgPSB7fTtcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdbcDN4LWNvbXBpbGVdJyxcbiAgICB0ZW1wbGF0ZTogYFxuICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwicmVuZGVyQ29tcG9uZW50XCI+XG4gICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0NvbXBvbmVudE91dGxldD1cImR5bmFtaWNDb21wb25lbnQ7IG5nTW9kdWxlRmFjdG9yeTogZHluYW1pY01vZHVsZTtcIj48L25nLWNvbnRhaW5lcj5cbiAgICAgICAgPC9uZy1jb250YWluZXI+XG4gICAgYFxufSlcbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDb21waWxlQXR0cmlidXRlIGltcGxlbWVudHMgT25DaGFuZ2VzIHtcbi8vZXhwb3J0IGNsYXNzIENvbXBpbGVBdHRyaWJ1dGUgaW1wbGVtZW50cyBPbkNoYW5nZXMgLE9uSW5pdCB7XG5cbiAgICBASW5wdXQoJ3AzeC1jb21waWxlJylcbiAgICBodG1sOiBzdHJpbmc7XG5cbiAgICBASW5wdXQoJ3AzeC1jb21waWxlLWN0eCcpXG4gICAgY29udGV4dDogYW55O1xuXG4gICAgQElucHV0KCdwM3gtY29tcGlsZS1lcnJvci1oYW5kbGVyJylcbiAgICBlcnJvckhhbmRsZXI6IEZ1bmN0aW9uID0gdW5kZWZpbmVkO1xuXG4gICAgZHluYW1pY0NvbXBvbmVudDogYW55O1xuICAgIGR5bmFtaWNNb2R1bGU6IE5nTW9kdWxlRmFjdG9yeTxhbnk+IHwgYW55O1xuXG4gICAgQElucHV0KCdwM3gtY29tcGlsZS1tb2R1bGUnKVxuICAgIG1vZHVsZTogTmdNb2R1bGU7XG5cbiAgICBASW5wdXQoJ3AzeC1jb21waWxlLWltcG9ydHMnKVxuICAgIGltcG9ydHM6IEFycmF5PFR5cGU8YW55PiB8IE1vZHVsZVdpdGhQcm92aWRlcnM8YW55PiB8IGFueVtdPjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICAvLyAgcHJpdmF0ZSBjb250YWluZXI6IFZpZXdDb250YWluZXJSZWYsXG4gICAgICAgIC8vIHByaXZhdGUgc2VydmljZTogQ29tcGlsZVNlcnZpY2VcbiAgICAgICAgcHJpdmF0ZSBjb21waWxlcjogQ29tcGlsZXIsXG4gICAgICAgIC8vIEBJbmplY3QoJ2NvbmZpZycpIHByaXZhdGUgY29uZmlnOkNvbXBpbGVTZXJ2aWNlQ29uZmlnXG4gICAgKSB7XG4gICAgfVxuXG4gICAgLypcbiAgICAvLyBub3QgcmVxdWlyZXMsIHNpbmNlIG5nT25DaGFuZ2VzIGRvZXMgaXQgZmlyc3QgdGltZSBjaGFuZ2VcbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgLy9jb25zb2xlLmxvZygnbmcgaW5pdCcpXG4gICAgICAgLy8gdGhpcy51cGRhdGUoKTtcbiAgICB9XG4gICAgICovXG5cbiAgICBnZXQgcmVuZGVyQ29tcG9uZW50KCkge1xuICAgICAgICByZXR1cm4gdHlwZW9mIHRoaXMuaHRtbCA9PT0gJ3N0cmluZycgJiYgdGhpcy5odG1sLnRyaW0oKSAhPT0gJydcbiAgICB9XG5cbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgICAgIC8vY29uc29sZS5sb2coJ25nIG9uZSBjaGFuZ2VzJylcbiAgICAgICAgdGhpcy51cGRhdGUoKTtcbiAgICB9XG5cblxuICAgIHVwZGF0ZSgpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICh0aGlzLmh0bWwgPT09IHVuZGVmaW5lZCB8fCB0aGlzLmh0bWwgPT09IG51bGwgfHwgdGhpcy5odG1sLnRyaW0oKSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5keW5hbWljQ29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHRoaXMuZHluYW1pY01vZHVsZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8qXG5cbiAgICAgICAgICAgIC8vIGxvb2tzIGxpa2UgQW5ndWxhciBhbHJlYWR5IGlzIGNhY2hpbmdcblxuICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnaHRtbCcsIHRoaXMuaHRtbClcbiAgICAgICAgICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5odG1sO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhPYmplY3Qua2V5cyhjYWNoZSkuaW5kZXhPZihjYWNoZUtleSksIGNhY2hlKVxuICAgICAgICAgICAgaWYgKGNhY2hlLmhhc093blByb3BlcnR5KGNhY2hlS2V5KSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRDYWNoZSA9IGNhY2hlW2NhY2hlS2V5XTtcbiAgICAgICAgICAgICAgICB0aGlzLmR5bmFtaWNDb21wb25lbnQgPSBjdXJyZW50Q2FjaGUuZHluYW1pY0NvbXBvbmVudFxuICAgICAgICAgICAgICAgIHRoaXMuZHluYW1pY01vZHVsZSA9IGN1cnJlbnRDYWNoZS5keW5hbWljTW9kdWxlXG4gICAgICAgICAgICAgICAgcmV0dXJuIDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICovXG4gICAgICAgICAgICB0aGlzLmR5bmFtaWNDb21wb25lbnQgPSB0aGlzLmNyZWF0ZU5ld0NvbXBvbmVudCh0aGlzLmh0bWwsIHRoaXMuY29udGV4dCk7XG4gICAgICAgICAgICB0aGlzLmR5bmFtaWNNb2R1bGUgPSB0aGlzLmNvbXBpbGVyLmNvbXBpbGVNb2R1bGVTeW5jKHRoaXMuY3JlYXRlQ29tcG9uZW50TW9kdWxlKHRoaXMuZHluYW1pY0NvbXBvbmVudCkpO1xuXG4gICAgICAgICAgICAvKlxuICAgICAgICAgICAgY2FjaGVbY2FjaGVLZXldID0ge1xuICAgICAgICAgICAgICAgIGR5bmFtaWNDb21wb25lbnQ6IHRoaXMuZHluYW1pY0NvbXBvbmVudCxcbiAgICAgICAgICAgICAgICBkeW5hbWljTW9kdWxlOiB0aGlzLmR5bmFtaWNNb2R1bGUsXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgKi9cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZXJyb3JIYW5kbGVyID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVycm9ySGFuZGxlcihlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvKlxuICAgICAgICAvLyBub3cgd2UgdXNlIGl0IHdpdGggbmdDb21wb25lbnRPdXRsZXQsIHNpbmNlIGFib3V0IGFuZ3VsYXIgNVxuICAgICAgICBhd2FpdCB0aGlzLnNlcnZpY2UuY29tcGlsZSh7XG4gICAgICAgICAgICB0ZW1wbGF0ZTogdGhpcy5odG1sLFxuICAgICAgICAgICAgY29udGFpbmVyOiB0aGlzLmNvbnRhaW5lcixcbiAgICAgICAgICAgIGNvbnRleHQ6IHRoaXMuY29udGV4dCxcbiAgICAgICAgICAgIGltcG9ydHM6IHRoaXMuaW1wb3J0cyxcbiAgICAgICAgICAgIG1vZHVsZTogdGhpcy5tb2R1bGVcbiAgICAgICAgfSlcbiAgICAgICAgKi9cbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUNvbXBvbmVudE1vZHVsZShjb21wb25lbnRUeXBlOiBhbnkpIHtcbiAgICAgICAgbGV0IG1vZHVsZTogTmdNb2R1bGUgPSB7fTtcblxuICAgICAgICBpZiAodGhpcy5tb2R1bGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbW9kdWxlID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5tb2R1bGUpO1xuICAgICAgICB9XG4gICAgICAgIC8qXG4gICAgICAgIGVsc2UgaWYgKFNpbmdsZXRvbkRlZmF1bHRNb2R1bGUgIT09IHVuZGVmaW5lZCAmJiBTaW5nbGV0b25EZWZhdWx0TW9kdWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBtb2R1bGUgPSBjbG9uZURlZXAoU2luZ2xldG9uRGVmYXVsdE1vZHVsZSk7XG4gICAgICAgIH1cbiAgICAgICAgKi9cbiAgICAgICAgbW9kdWxlLmltcG9ydHMgPSBtb2R1bGUuaW1wb3J0cyB8fCBbXTtcbiAgICAgICAgbW9kdWxlLmltcG9ydHMucHVzaChDb21tb25Nb2R1bGUpO1xuICAgICAgICBpZiAodGhpcy5pbXBvcnRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIG1vZHVsZS5pbXBvcnRzID0gbW9kdWxlLmltcG9ydHMuY29uY2F0KHRoaXMuaW1wb3J0cylcbiAgICAgICAgfVxuICAgICAgICBpZiAobW9kdWxlLmRlY2xhcmF0aW9ucyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBtb2R1bGUuZGVjbGFyYXRpb25zID0gW1xuICAgICAgICAgICAgICAgIGNvbXBvbmVudFR5cGVcbiAgICAgICAgICAgIF07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtb2R1bGUuZGVjbGFyYXRpb25zLnB1c2goY29tcG9uZW50VHlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgbW9kdWxlLmVudHJ5Q29tcG9uZW50cyA9IFtcbiAgICAgICAgICAgIGNvbXBvbmVudFR5cGVcbiAgICAgICAgXTtcblxuICAgICAgICBATmdNb2R1bGUobW9kdWxlKVxuICAgICAgICBjbGFzcyBSdW50aW1lQ29tcG9uZW50TW9kdWxlIHtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBSdW50aW1lQ29tcG9uZW50TW9kdWxlO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBjcmVhdGVOZXdDb21wb25lbnQoaHRtbDogc3RyaW5nLCBjb250ZXh0OiBhbnkpIHtcblxuICAgICAgICBjb25zdCBzZWxlY3Rvcjogc3RyaW5nID0gbmV4dElkKClcblxuICAgICAgICBAQ29tcG9uZW50KHtcbiAgICAgICAgICAgIHNlbGVjdG9yOiBzZWxlY3RvcixcbiAgICAgICAgICAgIHRlbXBsYXRlOiBodG1sXG4gICAgICAgIH0pXG4gICAgICAgIGNsYXNzIER5bmFtaWNDb21wb25lbnQge1xuICAgICAgICAgICAgY29udGV4dDogYW55ID0gY29udGV4dDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBEeW5hbWljQ29tcG9uZW50O1xuICAgIH1cbn1cbiJdfQ==